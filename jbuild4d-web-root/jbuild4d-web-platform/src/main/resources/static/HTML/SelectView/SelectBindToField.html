<!DOCTYPE html><html lang="zh" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"><head><meta charset="UTF-8"><title>Title</title><title>JBuild4D</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><script type="text/javascript" src="../../Js/T3P/JQuery/jquery-3.3.1.min.js"></script><script type="text/javascript" src="../../Js/T3P/VUE-2.5.16/vue.js"></script><script type="text/javascript" src="../../Js/T3P/IView-3.X/dist/iview.min.js"></script><script type="text/javascript" src="../../Js/T3P/JQuery-UI-1.12.1/jquery-ui.js"></script><script type="text/javascript" src="../../Js/T3P/ZTree-V3/js/jquery.ztree.all.js"></script><script type="text/javascript" src="../../Js/JBuild4DPlatformLib.js?refVersion=1"></script><script type="text/javascript" src="../../Js/UIEXComponent.js?refVersion=1"></script><script type="text/javascript" src="../../Js/VueEXComponent.js?refVersion=1"></script><script type="text/javascript" src="../../Js/T3P/ZTree-V3/js/jquery.ztree.exhide.js"></script><script type="text/javascript" src="../../Js/T3P/ZTree-V3/js/fuzzysearch.js"></script><link rel="stylesheet" type="text/css" href="../../Themes/Default/Css/Jbuild4dPlatform.css?refVersion=1"><link rel="stylesheet" type="text/css" href="../../Themes/Default/IView-3.X/iview.css"><link rel="stylesheet" type="text/css" href="../../Themes/Default/JQueryUI/jquery-ui.css"><link rel="stylesheet" type="text/css" href="../../Themes/Default/ZTree/zTreeStyle/zTreeStyle.css"><style>.select-table-wraper{border:#2d8cf0 1px solid;border-radius:4px;padding:10px;position:absolute;left:0;right:51%;bottom:50px;top:10px}.select-field-wraper{border:#2d8cf0 1px solid;border-radius:4px;padding:10px;position:absolute;left:51%;right:0;bottom:50px;top:10px}.select-old-field-tr td{background-color:#fcffdc!important}</style></head><body><div id="appSelectView" class="general-edit-page-wrap"><div class="select-table-wraper"><divider orientation="left" :dashed="true" style="font-size:12px">选择表</divider><input type="text" id="txtSearchTableTree" style="width:100%;height:32px;margin-top:2px"><ul id="tableZTreeUL" class="ztree"></ul></div><div class="select-field-wraper"><divider orientation="left" :dashed="true" style="font-size:12px">选择字段</divider><i-table border :columns="fieldTable.columnsConfig" :data="fieldTable.fieldData" class="iv-list-table" :highlight-row="true" @on-row-click="selectedField" :height="fieldTable.tableHeight" size="small" no-data-text="请选择表"></i-table></div><div class="button-outer-wrap"><div class="button-inner-wrap"><button-group><i-button type="primary" @click="selectComplete()">确 认</i-button><i-button type="primary" @click="clearComplete()">清 空</i-button><i-button @click="handleClose()">关 闭</i-button></button-group></div></div></div><script>var appSelectView=new Vue({
            el:"#appSelectView",
            data:{
                acInterface:{
                    getTablesDataUrl:"/PlatFormRest/Builder/DataStorage/DataBase/Table/GetTablesForZTreeNodeList",
                    getTableFieldsDataUrl:"/PlatFormRest/Builder/DataStorage/DataBase/Table/GetTableFieldsByTableId"
                },
                selectedData: {
                    tableId:"",
                    tableName: "",
                    tableCaption: "",
                    fieldName: "",
                    fieldCaption: "",
                    fieldDataType: "",
                    fieldLength: ""
                },
                tableTree:{
                    tableTreeObj:null,
                    tableTreeSetting:{
                        view: {
                            dblClickExpand: false,//双击节点时，是否自动展开父节点的标识
                            showLine: true,//是否显示节点之间的连线
                            fontCss: {'color': 'black', 'font-weight': 'normal'}
                        },
                        check: {
                            enable: true,
                            nocheckInherit: false,
                            chkStyle: "radio",
                            radioType: "all"
                        },
                        data: {
                            key: {
                                name: "text"
                            },
                            simpleData: {//简单数据模式
                                enable: true,
                                idKey: "id",
                                pIdKey: "parentId",
                                rootPId: "-1"// 1
                            }
                        },
                        callback: {
                            //点击树节点事件
                            onClick: function (event, treeId, treeNode) {
                                if(treeNode.nodeTypeName=="Table") {
                                    appSelectView.tableTree.tableTreeObj.checkNode(treeNode, true, true);
                                    appSelectView.selectedData.tableId=treeNode.id;
                                    //alert(appSelectView.selectedData.tableId);
                                    appSelectView.selectedData.tableName=treeNode.value;
                                    appSelectView.selectedData.tableCaption=treeNode.attr1;
                                    appSelectView.selectedData.fieldName="";
                                    appSelectView.selectedData.fieldCaption="";
                                    appSelectView.selectedData.fieldDataType="";
                                    appSelectView.selectedData.fieldLength="";
                                    appSelectView.bindFieldTable();
                                }
                                else{
                                    appSelectView.selectedData.tableId="";
                                    appSelectView.selectedData.tableName="";
                                    appSelectView.selectedData.tableCaption="";
                                    appSelectView.selectedData.fieldName="";
                                    appSelectView.selectedData.fieldCaption="";
                                    appSelectView.selectedData.fieldDataType="";
                                    appSelectView.selectedData.fieldLength="";
                                    appSelectView.fieldTable.fieldData=[];
                                }
                            },
                            onDblClick: function (event, treeId, treeNode) {

                            },
                            //成功的回调函数
                            onAsyncSuccess: function (event, treeId, treeNode, msg) {

                            }
                        }
                    },
                    tableTreeData:null,//${tableTreeData},
                    selectedTableName:"无"
                },
                fieldTable:{
                    fieldData:[],
                    tableHeight:470,
                    columnsConfig: [
                        {
                            title: '名称',
                            key: 'fieldName',
                            align: "center"
                        }, {
                            title: '标题',
                            key: 'fieldCaption',
                            align: "center"
                        }
                    ]
                }
            },
            mounted:function (){
                //alert("mounted");
                window.setTimeout(function () {
                    appSelectView.bindOldSelectedValue();
                    appSelectView.bindHistorySelectedValue();
                    appSelectView.bindTableTree();
                },400);
            },
            methods:{
                bindTableTree:function () {
                    var _self=this;
                    AjaxUtility.Post(this.acInterface.getTablesDataUrl,{},function (result) {
                        if(result.success) {
                            _self.tableTree.tableTreeData=result.data;
                            _self.tableTree.tableTreeObj=$.fn.zTree.init($("#tableZTreeUL"), _self.tableTree.tableTreeSetting,_self.tableTree.tableTreeData);
                            _self.tableTree.tableTreeObj.expandAll(true);
                            fuzzySearch("tableZTreeUL","#txtSearchTableTree",null,true);
                            if(!StringUtility.IsNullOrEmpty(_self.selectedData.tableId)){
                                var selectedNode=_self.tableTree.tableTreeObj.getNodeByParam("id",_self.selectedData.tableId);
                                _self.tableTree.tableTreeObj.checkNode(selectedNode, true, true);
                                _self.bindFieldTable();
                            }
                        }
                        else {
                            DialogUtility.Alert(window, DialogUtility.DialogAlertId, {}, result.message, null);
                        }
                    },"json");
                },
                bindFieldTable:function(){
                    var _self=this;
                    if(!StringUtility.IsNullOrEmpty(this.selectedData.tableId)){
                        AjaxUtility.Post(this.acInterface.getTableFieldsDataUrl,{"tableId":this.selectedData.tableId},function (result) {
                            if(result.success) {
                                _self.fieldTable.fieldData=result.data;
                                var oldSelectedValue=_self.selectedData;
                                if(!StringUtility.IsNullOrEmpty(oldSelectedValue.tableId)&&!StringUtility.IsNullOrEmpty(oldSelectedValue.fieldName)) {
                                    //ivu-table-row-highlight
                                    window.setTimeout(function() {
                                        $("span").each(function (j) {
                                            if ($(this).html() == oldSelectedValue.fieldName) {
                                                $(this).parent().parent().parent().addClass("select-old-field-tr");
                                            }
                                        })
                                    },300);
                                }
                            }
                            else {
                                DialogUtility.Alert(window, DialogUtility.DialogAlertId, {}, result.message, null);
                            }
                        },"json");
                    }
                    else{
                        DialogUtility.Alert(window, DialogUtility.DialogAlertId, {}, "请先选择表!", null);
                    }
                },
                bindOldSelectedValue:function(){
                    //debugger;
                    var oldSelectedValue= window.OpenerWindowObj[this.getSelectInstanceName()].getSelectFieldResultValue();
                    //debugger;
                    if(!StringUtility.IsNullOrEmpty(oldSelectedValue.tableId)) {
                        this.selectedData.tableId = oldSelectedValue.tableId;
                        this.selectedData.tableName = oldSelectedValue.tableName;
                        this.selectedData.tableCaption = oldSelectedValue.tableCaption;
                        this.selectedData.fieldName = oldSelectedValue.fieldName;
                        this.selectedData.fieldCaption = oldSelectedValue.fieldCaption;
                        this.selectedData.fieldDataType = oldSelectedValue.fieldDataType;
                        this.selectedData.fieldLength = oldSelectedValue.fieldLength;
                    }
                },
                bindHistorySelectedValue:function(){
                    //debugger;
                    if(StringUtility.IsNullOrEmpty(this.selectedData.tableId)){
                        var SBTF_TableId=CookieUtility.GetCookie("SBTF_TableId");
                        if(!StringUtility.IsNullOrEmpty(SBTF_TableId)){
                            var SBTF_TableName=CookieUtility.GetCookie("SBTF_TableName");
                            var SBTF_TableCaption=CookieUtility.GetCookie("SBTF_TableCaption");
                            this.selectedData.tableId =SBTF_TableId;
                            this.selectedData.tableName = SBTF_TableName;
                            this.selectedData.tableCaption = SBTF_TableCaption;
                        }
                    }
                },
                setHistorySelectedTableDataToCookie:function(tableId,tableName,tableCaption){
                    CookieUtility.SetCookie1Month("SBTF_TableId",tableId);
                    CookieUtility.SetCookie1Month("SBTF_TableName",tableName);
                    CookieUtility.SetCookie1Month("SBTF_TableCaption",tableCaption);
                },
                getSelectInstanceName:function () {
                    return BaseUtility.GetUrlParaValue("instanceName");
                },
                selectedField:function(selection,index){
                    //alert(selection.fieldName);
                    this.selectedData.fieldName=selection.fieldName;
                    this.selectedData.fieldCaption=selection.fieldCaption;
                    this.selectedData.fieldDataType=selection.fieldDataType;
                    this.selectedData.fieldLength=selection.fieldDataLength;
                },
                selectComplete:function () {
                    var result=this.selectedData;
                    if(!StringUtility.IsNullOrEmpty(result.tableId)&&!StringUtility.IsNullOrEmpty(result.fieldName)) {
                        window.OpenerWindowObj[this.getSelectInstanceName()].setSelectFieldResultValue(result);
                        this.setHistorySelectedTableDataToCookie(result.tableId,result.tableName,result.tableCaption);
                        this.handleClose();
                    }
                    else{
                        DialogUtility.Alert(window, DialogUtility.DialogAlertId, {},"请选择需要绑定的字段!", null);
                    }
                },
                clearComplete:function(){
                    window.OpenerWindowObj[this.getSelectInstanceName()].setSelectFieldResultValue(null);
                    this.handleClose();
                },
                handleClose: function () {
                    if(window.IsOpenForFrame){
                        DialogUtility.Frame_CloseDialog(window)
                    }
                    else {
                        DialogUtility.CloseOpenIframeWindow(window, DialogUtility.DialogId);
                    }
                }
            }
        })</script></body></html>
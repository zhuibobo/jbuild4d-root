<!DOCTYPE html><html lang="zh" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"><head><meta charset="UTF-8"><title>列表设计</title><title>JBuild4D</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><script type="text/javascript" src="../../../static/Js/T3P/JQuery/jquery-3.3.1.min.js"></script><script type="text/javascript" src="../../../static/Js/T3P/VUE-2.5.16/vue.js"></script><script type="text/javascript" src="../../../static/Js/T3P/IView-3.X/dist/iview.min.js"></script><script type="text/javascript" src="../../../static/Js/T3P/JQuery-UI-1.12.1/jquery-ui.js"></script><script type="text/javascript" src="../../../static/Js/T3P/ZTree-V3/js/jquery.ztree.all.js"></script><script type="text/javascript" src="../../../static/Js/T3P/perfect-scrollbar-14/perfect-scrollbar.js"></script><script type="text/javascript" src="../../../static/Js/JBuild4DPlatformLib.js?refVersion=1"></script><script type="text/javascript" src="../../../static/Js/UIEXComponent.js?refVersion=1"></script><script type="text/javascript" src="../../../static/Js/VueEXComponent.js?refVersion=1"></script><script type="text/javascript" src="../../../static/Js/T3P/ZTree-V3/js/jquery.ztree.exhide.js"></script><script type="text/javascript" src="../../../static/Js/T3P/ZTree-V3/js/fuzzysearch.js"></script><script type="text/javascript" src="../../../static/Js/T3P/Ckeditor-4.11.1-4Design/ckeditor.js"></script><script type="text/javascript" src="../../../static/Js/HTMLDesign/HTMLDesignUtility.js?refVersion=1"></script><script type="text/javascript" src="../../../static/Js/T3P/CodeMirror-5.39.2/lib/codemirror.js"></script><link rel="stylesheet" type="text/css" href="../../../static/Js/T3P/CodeMirror-5.39.2/lib/codemirror.css"><link rel="stylesheet" type="text/css" href="../../../static/Js/T3P/CodeMirror-5.39.2/theme/monokai.css"><script type="text/javascript" src="../../../static/Js/T3P/CodeMirror-5.39.2/mode/xml/xml.js"></script><script type="text/javascript" src="../../../static/Js/T3P/CodeMirror-5.39.2/mode/javascript/javascript.js"></script><script type="text/javascript" src="../../../static/Js/T3P/CodeMirror-5.39.2/mode/css/css.js"></script><script type="text/javascript" src="../../../static/Js/T3P/CodeMirror-5.39.2/mode/sql/sql.js"></script><script type="text/javascript" src="../../../static/Js/T3P/CodeMirror-5.39.2/mode/htmlmixed/htmlmixed.js"></script><script type="text/javascript" src="../../../static/Js/T3P/CodeMirror-5.39.2/addon/fold/foldcode.js"></script><script type="text/javascript" src="../../../static/Js/T3P/CodeMirror-5.39.2/addon/fold/foldgutter.js"></script><script type="text/javascript" src="../../../static/Js/T3P/CodeMirror-5.39.2/addon/fold/brace-fold.js"></script><script type="text/javascript" src="../../../static/Js/T3P/CodeMirror-5.39.2/addon/fold/xml-fold.js"></script><script type="text/javascript" src="../../../static/Js/T3P/CodeMirror-5.39.2/addon/fold/markdown-fold.js"></script><script type="text/javascript" src="../../../static/Js/T3P/CodeMirror-5.39.2/addon/fold/comment-fold.js"></script><script type="text/javascript" src="../../../static/Js/T3P/CodeMirror-5.39.2/addon/fold/brace-fold.js"></script><script type="text/javascript" src="../../../static/Js/T3P/CodeMirror-5.39.2/addon/util/formatting.js"></script><link rel="stylesheet" type="text/css" href="../../../static/Js/T3P/CodeMirror-5.39.2/addon/fold/foldgutter.css"><script type="text/javascript" src="../../../static/Js/T3P/CodeMirror-5.39.2/addon/search/search.js"></script><script type="text/javascript" src="../../../static/Js/T3P/CodeMirror-5.39.2/addon/search/searchcursor.js"></script><link rel="stylesheet" type="text/css" href="../../../static/Themes/Default/Css/Jbuild4dPlatform.css?refVersion=1"><link rel="stylesheet" type="text/css" href="../../../static/Themes/Default/IView-3.X/iview.css"><link rel="stylesheet" type="text/css" href="../../../static/Themes/Default/JQueryUI/jquery-ui.css"><link rel="stylesheet" type="text/css" href="../../../static/Themes/Default/ZTree/zTreeStyle/zTreeStyle.css"><style>.cke_button_label{display:inline!important}</style></head><body><div id="appForm" v-cloak><div style="position:absolute;right:10px;top:6px;z-index:100"><button-group size="small"><i-button icon="md-cloud-done" type="primary" @click="saveClose()">保存并关闭</i-button><i-button icon="md-search" type="primary" @click="savePreview()">保存并预览</i-button><i-button icon="md-checkmark" type="primary" @click="validateDesign()">校验列表设置</i-button><i-button icon="md-search" type="primary" @click="savePreview()">历史版本</i-button></button-group></div><tabs @on-click="tabChange" v-model="selectedTabName"><tab-pane name="Info" label="Info"><div style="width:1024px;margin:auto"><div style="width:500px;height:610px;border:#ddddf1 1px solid;border-radius:4px;padding:10px 20px 10px 10px;float:left"><divider orientation="left" :dashed="true" style="font-size:12px">表单信息</divider><i-form :model="listResourceEntity" :label-width="110"><form-item label="列表名称："><i-input v-model="listResourceEntity.listName" placeholder="请输入列表名称"></i-input></form-item><form-item label="唯一名称："><i-input v-model="listResourceEntity.listSingleName" placeholder="可以为空"></i-input></form-item><form-item label="绑定数据："><i-input v-model="listResourceEntity.listDatasetName" placeholder=""></i-input></form-item><form-item label="每次解析："><radio-group v-model="listResourceEntity.listEveryTimeResolve" type="button"><radio label="是">是</radio><radio label="否">否</radio></radio-group></form-item><form-item label="每页条数："><input-number :max="50" :min="5" v-model="listResourceEntity.listDatasetPageSize"></input-number></form-item><form-item label="主题："><i-select v-model="listResourceEntity.listTheme" @on-change="changeTheme"><i-option v-for="(item,key) in designThemes" :value="item.value" :key="key">{{item.name}}</i-option></i-select>如果风格重新引入CSS则必须在保存后再次打开才生效,或者使用保存并预览功能!</form-item><form-item label="备注：" style="margin-bottom:12px"><i-input v-model="listResourceEntity.listDesc" type="textarea" :autosize="{minRows: 5,maxRows: 5}"></i-input></form-item></i-form></div><div style="width:500px;height:610px;border:#ddddf1 1px solid;border-radius:4px;padding:10px 20px 10px 10px;float:right"><divider orientation="left" :dashed="true" style="font-size:12px">绑定数据集</divider><dataset-simple-select-comp @on-selected-dataset="selectedDataset"></dataset-simple-select-comp></div></div></tab-pane><tab-pane name="Design" label="Design"><div class="form-design-wraper"><div class="left-wraper" style="right:10px"><textarea name="html_design" id="html_design">
                    </textarea></div></div></tab-pane><tab-pane name="HTML" label="HTML"><div class="html-design-wraper"><div class="left-wraper code_wraper"><div class="inner"><textarea id="TextAreaHTMLEditor" style="height:99%"></textarea></div></div><div class="right-wraper"><tabs><tab-pane label="CodeFragment"><div>Config</div></tab-pane><tab-pane label="Element"><div>Element</div></tab-pane></tabs></div></div></tab-pane><tab-pane name="JS" label="JS"><div class="js-design-wraper"><div class="left-wraper code_wraper"><div class="inner"><textarea id="TextAreaJsEditor"></textarea></div></div><div class="right-wraper"><tabs><tab-pane label="CodeFragment"><js-design-code-fragment ref="jsDesignCodeFragment"></js-design-code-fragment></tab-pane><tab-pane label="Element"><design-html-elem-list ref="designHtmlElemList"></design-html-elem-list></tab-pane></tabs></div></div></tab-pane><tab-pane name="EXProp" label="EXProp"><div style="width:1024px;margin:auto"><div style="width:1024px;height:615px;border:#ddddf1 1px solid;border-radius:4px;padding:10px 20px 10px 10px"><divider orientation="left" :dashed="true" style="font-size:12px">扩展信息</divider><i-form :label-width="150"><form-item label="服务端渲染方法："><i-input v-model="listResourceEntity.listCustServerRenderer" placeholder="服务端自定义的渲染方法:继承IFormSeverRenderer"></i-input></form-item><form-item label="客户端渲染方法："><i-input v-model="listResourceEntity.listCustClientRenderer" placeholder="客户端自定义的渲染方法:需要指明具体的方法名称"></i-input></form-item><form-item label="引入JS：" style="margin-bottom:12px"><i-input v-model="listResourceEntity.listCustRefJs" placeholder="引入的脚本:多个通过;分割" type="textarea" :autosize="{minRows: 2,maxRows: 2}"></i-input></form-item><form-item label="备注：" style="margin-bottom:12px"><i-input v-model="listResourceEntity.listCustDesc" type="textarea" :autosize="{minRows: 4,maxRows: 4}"></i-input></form-item></i-form></div></div></tab-pane><tab-pane name="Be Referred" label="Be Referred"></tab-pane><tab-pane name="Config" label="Config"></tab-pane></tabs></div><script>var IsTopFramePage=true;
    var appForm = new Vue({
        el:"#appForm",
        data: {
            acInterface:{
                getTablesDataUrl:"/PlatFormRest/Builder/DataStorage/DataBase/Table/GetTablesForZTreeNodeList",
                getPluginsConfig:"/PlatFormRest/Builder/HtmlDesign/WebListDesign/GetPluginsConfig",
                saveDataUrl:"/PlatFormRest/Builder/List/SaveEdit",
                getDataUrl:"/PlatFormRest/Builder/List/GetDetailData"
            },
            currUserEntity:null,
            recordId:BaseUtility.GetUrlParaValue("recordId"),
            /*Js Bean*/
            listResourceEntity:{
                listId:"",
                listCode:"",
                listName:"",
                listSingleName:"",
                listCreateTime:DateUtility.GetCurrentData(),
                listCreater:"",
                listUpdateTime:DateUtility.GetCurrentData(),
                listUpdater:"",
                listType:"",
                listIssystem:"否",
                listOrderNum:"",
                listDesc:"",
                listModuleId:"",
                listStatus:"启用",
                listOrganId:"",
                listOrganName:"",
                listDatasetId:"",
                listDatasetName:"",
                listEveryTimeResolve:"否",
                listEnableSSear:"启用",
                listEnableCSear:"禁用",
                listTheme:"ThemeDefault",
                listCustServerRenderer:"",
                listCustRefJs:"",
                listCustClientRenderer:"",
                listCustDesc:"",
                listHtmlSource:"",
                listJsContent:"",
                listCssContent:"",
                listConfigContent:"",
                listDatasetPageSize:20

            },
            designThemes:[],
            status: BaseUtility.GetUrlParaValue("op"),
            oldSelectedTabName:"",
            selectedTabName:""
        },
        mounted:function () {
            this.initPageUI();
            //this.bindStatusData();
        },
        methods: {
            initPageUI:function(){
                $(".form-design-wraper").height(PageStyleUtility.GetWindowHeight()-60);
                var _self=this;

                //加载表单插件
                AjaxUtility.Post(this.acInterface.getPluginsConfig,{},function (result) {
                    console.log(result);

                    _self.designThemes=result.exKVData.designThemes;
                    _self.pluginVoList=result.data;

                    //加载表单数据
                    DetailPageUtility.BindFormData(_self.acInterface.getDataUrl, _self.listResourceEntity, _self.recordId, _self.status,null,function (result) {

                        if(_self.status=="add"){
                            _self.listResourceEntity.listType="WebList";
                            _self.listResourceEntity.listModuleId=BaseUtility.GetUrlParaValue("moduleId");
                            _self.oldSelectedTabName="Info";
                        }
                        else {
                            _self.listResourceEntity.listId=BaseUtility.GetUrlParaValue("recordId");

                            _self.oldSelectedTabName="Design";
                            _self.selectedTabName="Design";

                            _self.$refs.dbTableRelationComp.setValue(_self.listResourceEntity.formDataRelation);
                        }

                        //获取主题风格设置,传入表单设计器中进行引用!
                        //console.log(_self.designThemes);
                        var themeVo=_self.getTheme(_self.listResourceEntity.listTheme);
                        console.log(themeVo);
                        //初始化表单编辑器
                        CKEditorUtility.InitializeCKEditor('html_design',_self.pluginVoList,function () {

                            HTMLEditorUtility.SetHTMLEditorHTML(_self.listResourceEntity.listHtmlSource);
                            CKEditorUtility.SetCKEditorHTML(_self.listResourceEntity.listHtmlSource);
                            JsEditorUtility.SetJsEditorJs(_self.listResourceEntity.listJsContent);

                            _self.isLoading=false;
                        },"../../HTMLDesign/CKEditorConfig/CKEditorConfig.js","../../HTMLDesign/WebListDesign/Plugins/",themeVo);

                    });

                    HTMLEditorUtility.InitializeHTMLCodeDesign();
                    JsEditorUtility.InitializeJsCodeDesign(_self.status);

                    _self.$refs.jsDesignCodeFragment.setJSEditorInstance(JsEditorUtility.GetJsEditorInst());

                },"json");

            },
            getTheme:function(value){
                for(var i=0;i<this.designThemes.length;i++){
                    if(this.designThemes[i].value==value){
                        return this.designThemes[i];
                    }
                }
                return null;
            },
            changeTheme:function(value){
                //alert(value);
                var themeVo=this.getTheme(value);
                CKEditorUtility.SetThemeVo(themeVo);
            },
            isHTMLToOther:function(name){
                if(this.oldSelectedTabName=="HTML"){
                    //if(name=="Design"){
                    return true;
                    //}
                }
                return false;
            },
            isDesignToOther:function(name){
                if(this.oldSelectedTabName=="Design"){
                    //if(name=="HTML"){
                    return true;
                    //}
                }
                return false;
            },
            tabChange:function (name) {
                if(this.isDesignToOther(name)){
                    var html=CKEditorUtility.GetCKEditorHTML();
                    //JBuild4D.FormDesign.SetHTMLEditorHTML("<div id='aaa'><div><div><div>ssssssssss</div></div></div></div>");
                    HTMLEditorUtility.SetHTMLEditorHTML(html);
                }
                else if(this.isHTMLToOther(name)){
                    var html=HTMLEditorUtility.GetHtmlEditorHTML();
                    //alert(html);
                    CKEditorUtility.SetCKEditorHTML(html);
                }
                this.oldSelectedTabName=name;
            },
            selectedDataset:function(treeNode){
                this.listResourceEntity.listDatasetName=treeNode.text;
                this.listResourceEntity.listDatasetId=treeNode.id;
            },
            save:function (successFunc) {
                //var relationConfig=this.$refs.dbTableRelationComp.getValue();
                //this.formResourceEntity.formDataRelation=JsonUtility.JsonToString(relationConfig.relationData);
                //this.listResourceEntity.formMainTableId=relationConfig.mainTableId;
                //this.listResourceEntity.formMainTableName=relationConfig.mainTableName;
                //this.listResourceEntity.formMainTableCaption=relationConfig.mainTableCaption;
                if(this.selectedTabName=="HTML"){
                    this.listResourceEntity.listHtmlSource = HTMLEditorUtility.GetHtmlEditorHTML();
                }
                else {
                    this.listResourceEntity.listHtmlSource = CKEditorUtility.GetCKEditorHTML();
                }
                this.listResourceEntity.listJsContent=JsEditorUtility.GetJsEditorJs();

                var validateResult=this.validateSaveEnable(this.listResourceEntity);
                if(validateResult.result){
                    var sendData = JSON.stringify(this.listResourceEntity);
                    //debugger;
                    AjaxUtility.PostRequestBody(this.acInterface.saveDataUrl, sendData, function (result) {
                        //debugger;
                        DialogUtility.Alert(window, DialogUtility.DialogAlertId, {}, result.message, function () {
                            if (result.success) {
                                //window.OpenerWindowObj.appList.reloadData();
                                //DialogUtility.Frame_CloseDialog(window);
                                window.opener._modulelistwebformcomp.reloadData();
                                successFunc(result);
                            }
                        });
                    }, "json");
                }
                else{
                    DialogUtility.AlertText(validateResult.msg.join("<br />"));
                }
            },
            saveClose:function () {
                this.save(function () {
                    window.close();
                });
            },
            savePreview:function () {
                this.save(function () {

                })
            },
            validateSaveEnable:function(listResourceEntity){
                var resultMsg={
                    result:true,
                    msg:[]
                }

                if(listResourceEntity.listName==""){
                    resultMsg.result=false;
                    resultMsg.msg.push("请填写列表名称!");
                }
                return resultMsg;
            },
            validateDesign:function (listResourceEntity) {
                if(this.validateSaveEnable(listResourceEntity)){

                }
            }
        }
    });</script></body></html>
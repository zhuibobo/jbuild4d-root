<!DOCTYPE html><html lang="zh" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"><head><meta charset="UTF-8"><title>Title</title><th:block th:replace="Fragment/GeneralLib::GeneralLib"></th:block><th:block th:replace="Fragment/GeneralLib::IViewLib"></th:block><th:block th:replace="Fragment/GeneralLib::JQueryUILib"></th:block><th:block th:replace="Fragment/GeneralLib::EditTableLib"></th:block><th:block th:replace="Fragment/GeneralLib::ZTreeLib"></th:block><th:block th:replace="Fragment/GeneralLib::ZTreeExtendLib"></th:block><th:block th:replace="Fragment/GeneralLib::CodeMirror"></th:block><th:block th:replace="Fragment/GeneralLib::CodeMirrorSQL"></th:block><th:block th:replace="Fragment/GeneralLib::ThemesLib"></th:block><style>.CodeMirror{height:100px;width:100%}#TextAreaJsEditor{width:100%;height:100px}.tableTreeWrap{float:left;height:380px;width:40%;border:#01a0e4 1px solid;border-radius:4px;padding:6px}.tableFieldWrap{float:left;height:380px;width:57%;border:#01a0e4 1px solid;border-radius:4px;margin-left:10px;padding:10px}.tableName{color:#3b97ed;cursor:pointer}.tableName:hover{color:red}.validate-sql-enable-warp .result-item{border:#c8dcfe 1px solid;border-radius:4px;padding:4px;margin-bottom:4px}</style></head><body><div id="sqlDesignerForm" v-cloak><div><div style="width:100%">请编辑SQL语句[字段请统一使用大写]<div style="float:right;margin-bottom:8px"><!--<button-group>--><tooltip content="校验SQL" placement="left"><i-button size="small" type="success" icon="md-checkmark" @click="validateSQLEnable(null)"></i-button></tooltip><tooltip content="历史版本" placement="left"><i-button size="small" type="primary" icon="md-timer"></i-button></tooltip><tooltip content="预览数据" placement="left"><i-button size="small" type="primary" icon="md-search"></i-button></tooltip><tooltip content="格式化" placement="left"><i-button size="small" type="primary" icon="md-code"></i-button></tooltip><!--</button-group>--></div><div style="clear:bottom"></div></div><div style="height:120px;width:100%"><textarea id="TextAreaJsEditor">select TDEV_TEST_1.*,TDEV_TEST_2.F_TABLE1_ID,'address' ADDRESS,'sex' SEX from TDEV_TEST_1 join TDEV_TEST_2 on TDEV_TEST_1.ID=TDEV_TEST_2.F_TABLE1_ID where TDEV_TEST_1.ID='#{ApiVar.当前用户所在组织ID}'</textarea></div><div><tabs value="Tables"><tab-pane label="表" name="Tables"><div><div class="tableTreeWrap"><input type="text" id="txtSearchTableTree" style="width:100%"><ul id="tableZTreeUL" class="ztree"></ul></div><div class="tableFieldWrap">表：【<span class="tableName" @click="insertTableNameToCodeMirror">{{tree.selectedTableName}}</span>】<i-table size="small" height="335" stripe border :columns="tableField.columnsConfig" :data="tableField.fieldData" class="iv-list-table" :highlight-row="true"></i-table></div></div></tab-pane><tab-pane label="API变量" name="ApiVar"><ul id="apiVarZTreeUL" class="ztree"></ul></tab-pane><tab-pane label="日期时间" name="DateTime"><ul id="datetimeZTreeUL" class="ztree"></ul></tab-pane><tab-pane label="参考SQL" name="EgSQL"></tab-pane></tabs></div></div><div style="position:absolute;bottom:0;width:100%;text-align:center"><i-button type="success" @click="coverSQLDesign">覆 盖</i-button><i-button style="margin-left:8px" @click="appendSQLDesign">追 加</i-button><i-button style="margin-left:8px" @click="handleClose()">关 闭</i-button></div><div id="validateSQLEnableWarp" style="display:none" class="validate-sql-enable-warp"><div>解析为SQL</div><div class="result-item" id="sqlWithEnvValue"></div><div>变量替换SQL</div><div class="result-item" id="sqlWithEnvRunningValue"></div><div>获取结构SQL</div><div class="result-item" id="sqlWithEmptyData"></div><div>包含表</div><div class="result-item" id="relatedTables"></div><div>包含字段</div><div class="result-item" id="aboutColumns"></div></div></div><script>var sqlDesignerForm=new Vue({el:"#sqlDesignerForm",data:{acInterface:{getDataUrl:"/PlatForm/Builder/DataSet/DataSetSQLDesigner/GetSqlDesignerViewData"},formResourceEntity:{formId:""},tree:{datetimeTreeObj:null,datetimeTreeSetting:{view:{dblClickExpand:!1,showLine:!0,fontCss:{color:"black","font-weight":"normal"}},data:{key:{name:"text"},simpleData:{enable:!0,idKey:"id",pIdKey:"parentId",rootPId:"-1"}},callback:{onClick:function(e,t,a){1!=a.group?sqlDesignerForm.insertCodeAtCursor("#{"+a.type+"."+a.text+"}"):DialogUtility.Alert(window,DialogUtility.DialogAlertId,{},"不能选择分组！",null)},onDblClick:function(e,t,a){},onAsyncSuccess:function(e,t,a,i){}}},datetimeTreeData:null,apiVarTreeObj:null,apiVarTreeSetting:{view:{dblClickExpand:!1,showLine:!0,fontCss:{color:"black","font-weight":"normal"}},data:{key:{name:"text"},simpleData:{enable:!0,idKey:"id",pIdKey:"parentId",rootPId:"-1"}},callback:{onClick:function(e,t,a){1!=a.group?sqlDesignerForm.insertCodeAtCursor("#{"+a.type+"."+a.text+"}"):DialogUtility.Alert(window,DialogUtility.DialogAlertId,{},"不能选择分组！",null)},onDblClick:function(e,t,a){},onAsyncSuccess:function(e,t,a,i){}}},apiVarTreeData:null,tableTreeObj:null,tableTreeSetting:{view:{dblClickExpand:!1,showLine:!0,fontCss:{color:"black","font-weight":"normal"}},data:{key:{name:"text"},simpleData:{enable:!0,idKey:"id",pIdKey:"parentId",rootPId:"-1"}},callback:{onClick:function(e,t,a){sqlDesignerForm.getTableFields(a),sqlDesignerForm.tree.selectedTableName=a.value},onDblClick:function(e,t,a){},onAsyncSuccess:function(e,t,a,i){}}},tableTreeData:null,selectedTableName:"无"},tableField:{fieldData:[],columnsConfig:[{title:"字段名称",key:"fieldName",align:"center"},{title:"标题",key:"fieldCaption",align:"center"},{title:"操作",key:"fieldId",width:120,align:"center",render:function(e,t){return e("div",{class:"list-row-button-wrap"},[e("div",{class:"list-row-button list-row-button-listmanager",on:{click:function(){sqlDesignerForm.insertTableFieldToCodeMirror(t.row)}}})])}}]},sqlCodeMirror:null},mounted:function(){this.sqlCodeMirror=CodeMirror.fromTextArea($("#TextAreaJsEditor")[0],{mode:"text/x-sql",lineNumbers:!0,lineWrapping:!0,foldGutter:!0,theme:"monokai"}),AjaxUtility.Post(this.acInterface.getDataUrl,{},function(e){e.success?sqlDesignerForm.bindData(e):DialogUtility.Alert(window,DialogUtility.DialogAlertId,{},e.message,null)},"json")},methods:{bindData:function(e){this.tree.datetimeTreeData=e.exKVData.datetimeTreeData,this.tree.datetimeTreeObj=$.fn.zTree.init($("#datetimeZTreeUL"),this.tree.datetimeTreeSetting,this.tree.datetimeTreeData),this.tree.datetimeTreeObj.expandAll(!0),this.tree.apiVarTreeData=e.exKVData.apiVarTreeData,this.tree.apiVarTreeObj=$.fn.zTree.init($("#apiVarZTreeUL"),this.tree.apiVarTreeSetting,this.tree.apiVarTreeData),this.tree.apiVarTreeObj.expandAll(!0),this.tree.tableTreeData=e.exKVData.tableTreeData,this.tree.tableTreeObj=$.fn.zTree.init($("#tableZTreeUL"),this.tree.tableTreeSetting,this.tree.tableTreeData),this.tree.tableTreeObj.expandAll(!0),fuzzySearch("tableZTreeUL","#txtSearchTableTree",null,!0)},insertCodeAtCursor:function(e){var t=this.sqlCodeMirror.getDoc(),a=t.getCursor();t.replaceRange(e,a)},insertTableNameToCodeMirror:function(){this.insertCodeAtCursor(this.tree.selectedTableName)},insertTableFieldToCodeMirror:function(e){this.insertCodeAtCursor(this.tree.selectedTableName+"."+e.fieldName)},getEditSQL:function(){return this.sqlCodeMirror.getValue()},getTableFields:function(e){var t=e.id,a=this;AjaxUtility.Post("/PlatForm/Builder/DataSet/DataSetSQLDesigner/GetTableField.do",{tableId:t},function(e){e.success?a.tableField.fieldData=e.data:DialogUtility.Alert(window,DialogUtility.DialogAlertId,{},e.message,function(){})},"json")},handleClose:function(){DialogUtility.CloseOpenIframeWindow(window,DialogUtility.DialogId)},coverSQLDesign:function(){this.validateSQLEnable(function(e){window.parent.dataSetEditForm.clearColumn(),window.parent.dataSetEditForm.completedSQLDesign(e),sqlDesignerForm.handleClose()})},appendSQLDesign:function(){this.validateSQLEnable(function(e){window.parent.dataSetEditForm.completedSQLDesign(e),sqlDesignerForm.handleClose()})},validateSQLEnable:function(l){var n=this.getEditSQL();AjaxUtility.Post("/PlatForm/Builder/DataSet/DataSetSQLDesigner/ValidateSQLEnable.do",{sqlText:encodeURIComponent(n)},function(e){if(e.success)if(e.data.sqlWithEnvText=n,"function"==typeof l)l(e);else{$("#sqlWithEnvValue").html(e.data.sqlWithEnvValue),$("#sqlWithEnvRunningValue").html(e.data.sqlWithEnvRunningValue),$("#sqlWithEmptyData").html(e.data.sqlWithEmptyData);for(var t=new Array,a=0;a<e.data.dataSetVo.relatedTableVoList.length;a++)t.push(e.data.dataSetVo.relatedTableVoList[a].rtTableName+":"+e.data.dataSetVo.relatedTableVoList[a].rtTableCaption);var i=new Array;for(a=0;a<e.data.dataSetVo.columnVoList.length;a++)i.push(e.data.dataSetVo.columnVoList[a].columnName+":"+e.data.dataSetVo.columnVoList[a].columnCaption);$("#relatedTables").html(t.join("<br />")),$("#aboutColumns").html(i.join("<br />")),DialogUtility.DialogElem($("#validateSQLEnableWarp"),{modal:!0,title:"校验结果",width:900,height:550})}else DialogUtility.Alert(window,DialogUtility.DialogAlertId,{},e.message,function(){})},"json")}}})</script></body></html>
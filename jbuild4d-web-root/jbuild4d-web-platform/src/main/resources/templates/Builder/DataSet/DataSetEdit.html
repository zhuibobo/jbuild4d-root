<!DOCTYPE html>
<html lang="zh" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <th:block th:replace="Fragment/GeneralLib::GeneralLib"></th:block>
    <th:block th:replace="Fragment/GeneralLib::IViewLib"></th:block>
    <th:block th:replace="Fragment/GeneralLib::JQueryUILib"></th:block>
    <th:block th:replace="Fragment/GeneralLib::EditTableLib"></th:block>
    <th:block th:replace="Fragment/GeneralLib::ThemesLib"></th:block>
</head>
<body>
    <div id="dataSetEditForm" v-cloak>
        <div class="list-2column">
            <div class="left-outer-wrap-c" style="bottom: 50px;width: 335px;">
                <divider orientation="left" :dashed="true" style="font-size: 12px;padding: 10px">表信息</divider>
                <i-form :model="tableEntity" :label-width="90" style="margin-right: 10px">
                    <form-item label="标题：" prop="">
                        <i-input v-model="tableEntity.tableCaption"></i-input>
                    </form-item>
                    <form-item label="表名：" prop="">
                        <i-input v-model="tableEntity.tableName"></i-input>
                    </form-item>
                    <form-item label="创建时间：">
                        <date-picker type="date" placeholder="选择创建时间" v-model="tableEntity.tableCreateTime" disabled
                                     readonly style="width: 100%"></date-picker>
                    </form-item>
                    <form-item label="创建人：">
                        <i-input v-model="tableEntity.tableCreater"></i-input>
                    </form-item>
                    <form-item label="修改时间：">
                        <date-picker type="date" placeholder="选择创建时间" v-model="tableEntity.tableUpdateTime" disabled
                                     readonly style="width: 100%"></date-picker>
                    </form-item>
                    <form-item label="修改人：">
                        <i-input v-model="tableEntity.tableUpdater"></i-input>
                    </form-item>
                    <form-item label="系统表：">
                        <i-input v-model="tableEntity.tableIssystem" readonly></i-input>
                    </form-item>
                    <form-item label="备注：">
                        <i-input v-model="tableEntity.tableDesc" type="textarea" :autosize="{minRows: 10,maxRows: 10}"></i-input>
                    </form-item>
                </i-form>
            </div>
            <div class="right-outer-wrap-c" style="bottom: 50px;left: 350px;padding: 10px">
                <tabs value="Const">
                    <tab-pane label="SQL数据集" name="Const" >
                        <div style="width: 100%;height: 60px">
                            <div style="float:left;width: 88%;border: red 1px solid;border-radius: 4px;height: 50px;padding: 4px">
                                {{sqlWithEnvText}}
                            </div>
                            <div @click="designSQL" style="float: left;width: 5%;border: red 1px solid;border-radius: 4px;height: 50px;text-align: center;line-height: 50px;margin-left: 10px;cursor: pointer">
                                编辑
                            </div>
                            <div style="float: left;width: 5%;border: red 1px solid;border-radius: 4px;height: 50px;text-align: center;line-height: 50px;margin-left: 10px;cursor: pointer">
                                预览
                            </div>
                        </div>
                    </tab-pane>
                    <tab-pane label="API数据集" name="DateTime">
                        <div style="width: 100%;height: 30px">
                        </div>
                    </tab-pane>
                    <tab-pane label="REST数据集" name="ApiVar">
                    </tab-pane>
                    <tab-pane label="自定义数据集" name="Cust">
                    </tab-pane>
                </tabs>
                <div style="width: 70%;float: left;margin-right: 10px">
                    <div style="width: 100%">
                        <div style="float: right;margin-bottom: 8px">
                            编辑列 &nbsp;
                            <button-group>
                                <i-button size="small" type="success" icon="md-add" @click="addField"></i-button>
                                <i-button size="small" type="primary" icon="md-close" @click="removeField"></i-button>
                                <i-button size="small" type="primary" icon="ios-arrow-up" @click="moveField('up')"></i-button>
                                <i-button size="small" type="primary" icon="ios-arrow-down" @click="moveField('down')"></i-button>
                            </button-group>
                        </div>
                        <div style="clear: bottom"></div>
                    </div>
                    <div id="divEditTable" class="edit-table-wrap" style="height: 100px;overflow: auto;width: 100%"></div>
                </div>
                <div style="width: 29%;float: left">
                    <div style="height: 22px;margin-bottom: 8px;line-height: 22px;padding-right: 10px">
                        <div style="float: right">
                            相关表
                        </div>
                    </div>
                    <i-table size="small" stripe border :columns="relatedTable.config" :data="relatedTable.data"
                             class="iv-list-table" :highlight-row="true"></i-table>
                </div>
            </div>
        </div>
        <div style="position: absolute;bottom: 0px;width: 100%;text-align: center">
            <i-button type="primary" @click="saveEditTable()"> 保 存</i-button>
            <i-button style="margin-left: 8px" @click="handleClose()">关 闭</i-button>
        </div>
    </div>
    <script>
        var dataSetEditForm = new Vue({
            el:"#dataSetEditForm",
            data:{
                currUserEntity:null,
                tableEntity:{
                    tableId:"",
                    tableCaption:"",
                    tableName:"",
                    tableCreateTime:DateUtility.GetCurrentData(),
                    tableCreater:"",
                    tableUpdateTime:DateUtility.GetCurrentData(),
                    tableUpdater:"",
                    tableType:"",
                    tableIssystem:"否",
                    tableDesc: "",
                    tableGroupId:""
                },
                editTableObj:null,
                editTableConfig:{
                    Status:"Edit",//状态 编辑 Edit 浏览 View
                    DataField:"fieldName",
                    //AddAfterRowEvent:TableDetailUtil.AfterInitEvent,
                    Templates:[
                        {
                            Title:"字段ID",
                            BindName:"columnId",
                            Renderer:"EditTable_Label",
                            TitleCellClassName:"TitleCell",
                            DefaultValue:{
                                Type:"GUID",
                                Value:0
                            },
                            Hidden:true
                        },
                        {
                            Title:"标题",
                            BindName:"columnCaption",
                            Renderer:"EditTable_TextBox",
                            TitleCellClassName:"TitleCell",
                            Validate:{
                                Type:"NotEmpty"
                            },
                            Hidden:false,
                            TitleCellAttrs:{},
                            Style:{
                                width:150
                            }
                        },{
                            Title:"名称",
                            BindName:"columnName",
                            Renderer:"EditTable_FieldName",
                            Validate:{
                                Type:"SQLKeyWord"
                            },
                            DefaultValue:{
                                Type:"Const",
                                Value:"F_"
                            },
                            Style:{
                                width:150
                            },
                            Hidden:false
                        },{
                            Title:"自定义",
                            BindName:"columnIsCustom",
                            Renderer:"EditTable_Label",
                            Style:{
                                width:80,
                                textAlign:"center"
                            },
                            Hidden:false
                        },{
                            Title:"备注",
                            BindName:"columnDesc",
                            Renderer:"EditTable_TextBox",
                            Hidden:false,
                            Style:{
                                width:280,
                                textAlign:"center"
                            }
                        },{
                            Title:"默认值",
                            BindName:"columnDefaultValue",
                            Renderer:"EditTable_Label",
                            Hidden:false
                        }
                    ],
                    RowIdCreater:function(){

                    },
                    TableClass:"edit-table",
                    RendererTo:"divEditTable",//div elem
                    TableId:"TableFields",
                    TableAttrs:{cellpadding:"1",cellspacing:"1",border:"1"}
                },
                status: '${op}',
                relatedTable: {
                    config: [
                        {
                            title: '表名',
                            key: 'rtTableName',
                            align: "center"
                        }, {
                            title: '标题',
                            key: 'rtTableCaption',
                            align: "center"
                        }
                    ],
                    data: []
                },
                sqlWithEnvText:"请编辑SQL"
            },
            mounted:function () {
                this.editTableObj=Object.create(EditTable);
                this.editTableObj.Initialization(this.editTableConfig);
                if(this.status=="add"){
                    //this.editTableObj.LoadJsonData(this.templateFieldGroup[this.useTemplateName]);
                    this.tableEntity.tableCreater=this.currUserEntity.userName;
                    this.tableEntity.tableUpdater=this.currUserEntity.userName;
                }
                else {
                    //this.editTableObj.LoadJsonData(this.tableFieldsData);
                    this.tableEntity.tableUpdater=this.currUserEntity.userName;
                }
                $("#divEditTable").height($(".right-outer-wrap-c").height()-185);
            },
            methods:{
                addField:function(){
                    this.editTableObj.AddEditingRowByTemplate();
                },
                removeField:function () {
                    this.editTableObj.RemoveRow();
                },
                moveField:function (type) {
                    var editRow=this.editTableObj.GetEditRow();
                    if(editRow!=null){
                        var _self=this;
                        var rowId=editRow.attr("id");
                        var fieldId=this.editTableObj.GetSelectRowDataByRowId(rowId).fieldId;
                        var url = '/PlatForm/Builder/DataStorage/DataBase/Table/Move.do';
                        AjaxUtility.Post(url, {recordId: fieldId,type:type}, function (result) {
                            if (result.success) {
                                DialogUtility.Alert(window, DialogUtility.DialogAlertId, {}, result.message, function () {
                                    if(type=="down") {
                                        _self.editTableObj.MoveDown();
                                    }else{
                                        _self.editTableObj.MoveUp();
                                    }
                                });
                            }
                            else {
                                DialogUtility.Alert(window, DialogUtility.DialogAlertId, {}, result.message,null);
                            }
                        }, "json");
                    }
                },
                saveEditTable:function () {
                    if(this.tableEntity.tableCaption.replace(/(^\s*)|(\s*$)/g, "")==""){
                        DialogUtility.Alert(window,DialogUtility.DialogAlertId,{}, "表标题不能为空！",null);
                        return false;
                    }
                    if(/^[a-zA-Z][a-zA-Z0-9_]{0,}$/.test(this.tableEntity.tableName) == false){
                        DialogUtility.Alert(window,DialogUtility.DialogAlertId,{}, "表名称不能为空且只能是字母、下划线、数字并以字母开头！",null);
                        return false;
                    }

                    if (this.editTableObj.CompletedEditingRow()) {
                        console.log(this.editTableObj.GetSerializeJson());
                        var sendData = {
                            op: this.status,
                            ignorePhysicalError:this.ignorePhysicalError,
                            tableEntityJson: encodeURIComponent(JSON.stringify(this.tableEntity)),
                            fieldVoListJson: encodeURIComponent(JSON.stringify(this.editTableObj.GetSerializeJson()))
                        };
                        //return;
                        var url = '/PlatForm/Builder/DataStorage/DataBase/Table/SaveTableEdit.do';
                        AjaxUtility.Post(url, sendData, function (result) {
                            //debugger;
                            DialogUtility.Alert(window, DialogUtility.DialogAlertId, {}, result.message, function () {
                                if (result.success) {
                                    window.OpenerWindowObj.appList.reloadData();
                                    DialogUtility.Frame_CloseDialog(window);
                                }
                            });
                        }, "json");
                    }
                },
                handleClose: function () {
                    DialogUtility.Frame_CloseDialog(window);
                },
                designSQL:function () {
                    var url=BaseUtility.BuildAction("/PlatForm/Builder/DataSet/DataSetSQLDesigner/SQLDesigner",{});
                    DialogUtility.OpenIframeWindow(window, DialogUtility.DialogId, url, {title: "编辑SQL语句",modal:true}, 1);
                },
                completedSQLDesign:function (result) {
                    this.sqlWithEnvText=result.data.sqlWithEnvText;
                    this.relatedTable.data=result.data.dataSetVo.relatedTableVoList;
                    //获取现有的列定义
                    var oldColumnData=this.editTableObj.GetSerializeJson();
                    if(oldColumnData.length==0) {
                        this.editTableObj.LoadJsonData(result.data.dataSetVo.columnVoList);
                    }
                    else {
                        for(var i=0;i<oldColumnData.length;i++){
                            //var columnName=oldColumnData.columnName;
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>
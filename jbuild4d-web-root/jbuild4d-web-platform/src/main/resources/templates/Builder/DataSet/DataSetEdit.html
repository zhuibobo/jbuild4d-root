<!DOCTYPE html><html lang="zh" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"><head><meta charset="UTF-8"><title>Title</title><th:block th:replace="Fragment/GeneralLib::GeneralLib"></th:block><th:block th:replace="Fragment/GeneralLib::IViewLib"></th:block><th:block th:replace="Fragment/GeneralLib::JQueryUILib"></th:block><th:block th:replace="Fragment/GeneralLib::EditTableLib"></th:block><th:block th:replace="Fragment/GeneralLib::ThemesLib"></th:block></head><body><div id="dataSetEditForm" v-cloak><div class="list-2column"><div class="left-outer-wrap-c" style="bottom:50px;right:350px"><div style="width:98%;margin:auto"><tabs v-model="datasetEntity.dsType"><tab-pane label="SQL数据集" name="SQLDataSet"><div style="width:100%;height:60px"><div style="float:left;width:86%;border:red 1px solid;border-radius:4px;height:50px;padding:4px">{{datasetEntity.dsSqlSelectText}}</div><div @click="designSQL" style="color:#fff;background-color:#47cb89;float:left;width:5%;border:red 1px solid;border-radius:4px;height:50px;text-align:center;line-height:50px;margin-left:10px;cursor:pointer">编辑</div><div style="float:left;width:5%;border:red 1px solid;border-radius:4px;height:50px;text-align:center;line-height:50px;margin-left:10px;cursor:pointer">预览</div></div></tab-pane><tab-pane label="API数据集" name="APIDataSet"><div style="width:100%;height:30px" name="APIDataSetInnerWraper"><i-input v-model="datasetEntity.dsClassName" search enter-button="加载" @on-search="loadApiDataSetVo"><span slot="prepend">类全称[继承com.jbuild4d.platform.builder.extend.IDataSetAPI]：</span></i-input></div></tab-pane><tab-pane label="REST数据集" name="RESTDataSet"><div style="width:100%;height:60px"><i-input size="small" v-model="datasetEntity.dsRestStructureUrl" search enter-button="加载" @on-search="loadRestDataSetVo"><span slot="prepend">获取结构URL：</span></i-input><i-input style="margin-top:4px" size="small" v-model="datasetEntity.dsRestDataUrl" search enter-button="测试" @on-search="testRestDataSetVo"><span slot="prepend">数据提供URL：</span></i-input></div></tab-pane><tab-pane label="自定义数据集" name="CUSTOMDataSet"></tab-pane></tabs><div style="width:70%;float:left;margin-right:10px"><div style="width:100%"><div style="float:right;margin-bottom:8px">编辑列 &nbsp;<button-group><i-button size="small" type="success" icon="md-add" @click="addColumn"></i-button><i-button size="small" type="primary" icon="md-close" @click="removeColumn"></i-button><i-button size="small" type="primary" icon="ios-arrow-up" @click="moveColumn('up')"></i-button><i-button size="small" type="primary" icon="ios-arrow-down" @click="moveColumn('down')"></i-button><i-button size="small" type="primary" icon="md-trash" @click="clearColumn()"></i-button></button-group></div><div style="clear:bottom"></div></div><div id="divEditTable" class="edit-table-wrap" style="height:100px;overflow:auto;width:100%"></div></div><div style="width:28%;float:left"><div style="height:22px;margin-bottom:8px;line-height:22px;padding-right:10px"><div style="float:right">相关表</div></div><i-table size="small" stripe border :columns="relatedTable.config" :data="relatedTable.data" class="iv-list-table" :highlight-row="true"></i-table></div></div></div><div class="right-outer-wrap-c" style="bottom:50px;width:340px;padding:10px"><divider orientation="left" :dashed="true" style="font-size:12px;padding:10px">数据集信息</divider><i-form :model="datasetEntity" :rules="ruleValidate" :label-width="90" style="margin-right:10px"><form-item label="标题：" prop="dsCaption"><i-input v-model="datasetEntity.dsCaption"></i-input></form-item><form-item label="名称：" prop="dsName"><i-input v-model="datasetEntity.dsName"></i-input></form-item><form-item label="创建人："><row><i-col span="6"><i-input v-model="datasetEntity.dsCreater"></i-input></i-col><i-col span="8" style="text-align:center">创建时间：</i-col><i-col span="10"><form-item><date-picker type="date" placeholder="选择创建时间" v-model="datasetEntity.dsCreateTime" disabled="disabled" readonly="readonly" style="width:100%"></date-picker></form-item></i-col></row></form-item><form-item label="修改人："><row><i-col span="6"><i-input v-model="datasetEntity.dsUpdater"></i-input></i-col><i-col span="8" style="text-align:center">修改时间：</i-col><i-col span="10"><form-item><date-picker type="date" placeholder="选择创建时间" v-model="datasetEntity.dsUpdateTime" disabled="disabled" readonly="readonly" style="width:100%"></date-picker></form-item></i-col></row></form-item><form-item label="系统表："><i-input v-model="datasetEntity.dsIssystem" readonly="readonly"></i-input></form-item><form-item label="备注："><i-input v-model="datasetEntity.dsDesc" type="textarea" :autosize="{minRows: 5,maxRows: 5}"></i-input></form-item></i-form></div></div><div style="position:absolute;bottom:0;width:100%;text-align:center"><i-button type="primary" @click="saveEditDataSet()">保 存</i-button><i-button style="margin-left:8px" @click="handleClose()">关 闭</i-button></div></div><script>var dataSetEditForm=new Vue({el:"#dataSetEditForm",data:{acInterface:{getDataUrl:"/PlatForm/Builder/DataSet/DataSetDesign/GetDataSetData",saveDataUrl:"/PlatForm/Builder/DataSet/DataSetDesign/SaveDataSetEdit",loadApiDataUrl:"/PlatForm/Builder/DataSet/DataSetDesign/GetApiDataSetVoStructure"},currUserEntity:null,ruleValidate:{dsCaption:[{required:!0,message:"【标题】不能空！",trigger:"blur"}],dsName:[{required:!0,message:"【名称】不能空！",trigger:"blur"}]},datasetEntity:{dsId:"",dsCaption:"数据集1",dsName:"DS1",dsCreateTime:DateUtility.GetCurrentData(),dsCreater:"",dsUpdateTime:DateUtility.GetCurrentData(),dsUpdater:"",dsType:"",dsIssystem:"否",dsDesc:"",dsGroupId:"",dsStatus:"启用",dsSqlSelectText:"",dsSqlSelectValue:"",dsClassName:"com.jbuild4d.platform.builder.extend.impl.DemoDataSetAPI",dsRestStructureUrl:"",dsRestDataUrl:"",columnVoList:null,relatedTableVoList:null},editTableObj:null,editTableConfig:{Status:"Edit",DataField:"fieldName",Templates:[{Title:"字段ID",BindName:"columnId",Renderer:"EditTable_Label",TitleCellClassName:"TitleCell",DefaultValue:{Type:"GUID",Value:0},Hidden:!0},{Title:"标题",BindName:"columnCaption",Renderer:"EditTable_TextBox",TitleCellClassName:"TitleCell",Validate:{Type:"NotEmpty"},Hidden:!1,TitleCellAttrs:{},Style:{width:150}},{Title:"名称",BindName:"columnName",Renderer:"EditTable_FieldName",Validate:{Type:"SQLKeyWord"},DefaultValue:{Type:"Const",Value:"F_"},Style:{width:150},Hidden:!1},{Title:"自定义",BindName:"columnIsCustom",Renderer:"EditTable_Label",Style:{width:80,textAlign:"center"},DefaultValue:{Type:"Const",Value:"是"},Hidden:!1},{Title:"备注",BindName:"columnDesc",Renderer:"EditTable_TextBox",Hidden:!1,Style:{width:180,textAlign:"center"}},{Title:"格式化方法",BindName:"columnFormatter",Renderer:"EditTable_TextBox",Hidden:!1},{Title:"默认值",BindName:"columnDefaultValue",Renderer:"Column_SelectDefaultValue",Hidden:!1,Style:{width:220}}],RowIdCreater:function(){},TableClass:"edit-table",RendererTo:"divEditTable",TableId:"dsColumns",TableAttrs:{cellpadding:"1",cellspacing:"1",border:"1"}},status:BaseUtility.GetUrlParaValue("op"),relatedTable:{config:[{title:"表名",key:"rtTableName",align:"center"},{title:"标题",key:"rtTableCaption",align:"center"}],data:[]}},mounted:function(){this.editTableObj=Object.create(EditTable),this.editTableObj.Initialization(this.editTableConfig),this.currUserEntity=CacheDataUtility.GetCurrentUserInfo(),"add"==this.status?(this.datasetEntity.dsCreater=this.currUserEntity.userName,this.datasetEntity.dsUpdater=this.currUserEntity.userName,this.datasetEntity.dsId=StringUtility.Guid(),this.datasetEntity.dsGroupId=BaseUtility.GetUrlParaValue("groupId"),this.datasetEntity.dsType="SQLDataSet",this.datasetEntity.dsSqlSelectText="请编辑SQL"):(this.datasetEntity.dsId=BaseUtility.GetUrlParaValue("recordId"),this.datasetEntity.dsUpdater=this.currUserEntity.userName,this.loadData(this.datasetEntity.dsId,this.status)),$("#divEditTable").height($(".right-outer-wrap-c").height()-185)},created:function(){},methods:{loadData:function(t,e){var a=this;AjaxUtility.Post(this.acInterface.getDataUrl,{recordId:t,op:e},function(t){t.success?(console.log(t),a.datasetEntity=t.data,a.editTableObj.LoadJsonData(a.datasetEntity.columnVoList),a.relatedTable.data=a.datasetEntity.relatedTableVoList,"view"==e&&DetailPageUtility.IViewPageToViewStatus(),"APIDataSet"==a.datasetEntity.dsType&&window.setTimeout(function(){$("[name='APIDataSetInnerWraper']").css("visibility","visible")},500)):DialogUtility.Alert(window,DialogUtility.DialogAlertId,{},t.message,null)},"json")},addColumn:function(){this.editTableObj.AddEditingRowByTemplate()},removeColumn:function(){this.editTableObj.RemoveRow()},clearColumn:function(){this.editTableObj.RemoveAllRow()},moveColumn:function(t){"up"==t?this.editTableObj.MoveUp():this.editTableObj.MoveDown()},saveEditDataSet:function(){if(""==this.datasetEntity.dsCaption.replace(/(^\s*)|(\s*$)/g,""))return DialogUtility.Alert(window,DialogUtility.DialogAlertId,{},"数据集标题不能为空！",null),!1;if(0==/^[a-zA-Z][a-zA-Z0-9_]{0,}$/.test(this.datasetEntity.dsName))return DialogUtility.Alert(window,DialogUtility.DialogAlertId,{},"数据集名称不能为空且只能是字母、下划线、数字并以字母开头！",null),!1;if(this.editTableObj.CompletedEditingRow()){if(console.log(this.editTableObj.GetSerializeJson()),this.datasetEntity.columnVoList=this.editTableObj.GetSerializeJson(),this.datasetEntity.relatedTableVoList=this.relatedTable.data,this.datasetEntity.columnVoList)for(var t=0;t<this.datasetEntity.columnVoList.length;t++)""!=this.datasetEntity.columnVoList[t].columnId&&null!=this.datasetEntity.columnVoList[t].columnId||(this.datasetEntity.columnVoList[t].columnId=StringUtility.Guid());if(this.datasetEntity.relatedTableVoList)for(t=0;t<this.datasetEntity.relatedTableVoList.length;t++)""!=this.datasetEntity.relatedTableVoList[t].rtId&&null!=this.datasetEntity.relatedTableVoList[t].rtId||(this.datasetEntity.relatedTableVoList[t].rtId=StringUtility.Guid());var e={op:this.status,dataSetId:this.datasetEntity.dsId,dataSetVoJson:JSON.stringify(this.datasetEntity)};AjaxUtility.Post(this.acInterface.saveDataUrl,e,function(t){DialogUtility.Alert(window,DialogUtility.DialogAlertId,{},t.message,function(){t.success&&(window.OpenerWindowObj.appList.reloadData(),DialogUtility.Frame_CloseDialog(window))})},"json")}},handleClose:function(){DialogUtility.Frame_CloseDialog(window)},designSQL:function(){var t=BaseUtility.BuildAction("/PlatForm/Builder/DataSet/DataSetSQLDesigner/SQLDesigner",{});DialogUtility.OpenIframeWindow(window,DialogUtility.DialogId,t,{title:"编辑SQL语句",modal:!0},1)},completedSQLDesign:function(t){if(this.datasetEntity.dsSqlSelectText=t.data.sqlWithEnvText,this.datasetEntity.dsSqlSelectValue=t.data.sqlWithEnvValue,this.relatedTable.data=t.data.dataSetVo.relatedTableVoList,this.editTableObj.CompletedEditingRow()){var e=this.editTableObj.GetSerializeJson();if(0==e.length)this.editTableObj.LoadJsonData(t.data.dataSetVo.columnVoList);else{for(var a=this.editTableObj.GetSerializeJson(),i=0;i<t.data.dataSetVo.columnVoList.length;i++){for(var l=t.data.dataSetVo.columnVoList[i].columnName,d=!0,s=0;s<e.length;s++){if(e[s].columnName==l){d=!1;break}}d&&a.push(t.data.dataSetVo.columnVoList[i])}this.editTableObj.RemoveAllRow(),this.editTableObj.LoadJsonData(a)}}},loadApiDataSetVo:function(){var e=this,t=this.datasetEntity.dsId,a=this.status,i=this.datasetEntity.dsGroupId,l=this.datasetEntity.dsClassName;AjaxUtility.Post(this.acInterface.loadApiDataUrl,{recordId:t,op:a,groupId:i,fullClassName:l},function(t){t.success?(e.clearColumn(),e.datasetEntity.dsCaption=t.data.dsCaption,e.datasetEntity.dsName=t.data.dsName,e.editTableObj.LoadJsonData(t.data.columnVoList),e.relatedTable.data=t.data.relatedTableVoList):DialogUtility.Alert(window,DialogUtility.DialogAlertId,{},t.message,null)},"json")},loadRestDataSetVo:function(){},testRestDataSetVo:function(){}}})</script></body></html>
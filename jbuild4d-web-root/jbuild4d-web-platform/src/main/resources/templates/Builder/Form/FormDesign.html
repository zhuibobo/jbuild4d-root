<!DOCTYPE html>
<html lang="zh" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>表单设计</title>
    <th:block th:replace="Fragment/GeneralLib::GeneralLib"></th:block>
    <th:block th:replace="Fragment/GeneralLib::IViewLib"></th:block>
    <th:block th:replace="Fragment/GeneralLib::JQueryUILib"></th:block>
    <th:block th:replace="Fragment/GeneralLib::ThemesLib"></th:block>
    <th:block th:replace="Fragment/GeneralLib::FormDesignLib"></th:block>
    <th:block th:replace="Fragment/GeneralLib::CodeMirror"></th:block>
    <th:block th:replace="Fragment/GeneralLib::CodeMirrorHTML"></th:block>
    <th:block th:replace="Fragment/GeneralLib::CodeMirrorFold"></th:block>
    <th:block th:replace="Fragment/GeneralLib::ZTreeLib"></th:block>
    <th:block th:replace="Fragment/GeneralLib::ZTreeExtendLib"></th:block>
    <style>
        .cke_button_label {
            display:inline !important;
        }
    </style>
</head>
<body>
<div id="appForm" class="general-edit-page-wrap" v-cloak>
    <div style="position: absolute;right: 10px;top: 10px;background-color: #00B83F">
        按钮
    </div>
    <tabs @on-click="tabChange">
        <tab-pane name="Info" label="Info">
            <div style="width: 1024px;margin: auto">
                <div style="width: 1024px;height: 560px;border: #ddddf1 1px solid;border-radius: 4px;padding: 10px 20px 10px 10px;">
                    <divider orientation="left" :dashed="true" style="font-size: 12px">表单信息</divider>
                    <i-form  :model="formResourceEntity" :rules="ruleValidate" :label-width="110">
                        <form-item label="表单名称：" prop="formName">
                            <row>
                                <i-col span="10">
                                    <i-input v-model="formResourceEntity.formName"></i-input>
                                </i-col>
                                <i-col span="4" style="text-align: center">唯一名称：</i-col>
                                <i-col span="10">
                                    <i-input v-model="formResourceEntity.formSingleName"></i-input>
                                </i-col>
                            </row>
                        </form-item>
                        <form-item label="备注：" style="margin-bottom: 12px">
                            <i-input v-model="formResourceEntity.formDesc" type="textarea" :autosize="{minRows: 2,maxRows: 2}"></i-input>
                        </form-item>
                    </i-form>
                    <divider orientation="left" :dashed="true" style="font-size: 12px">数据关系关联设置</divider>
                    <div style="float: left;width: 300px;height: 330px;border: #ddddf1 1px solid;border-radius: 4px;padding: 10px 10px 10px 10px;">
                        <button-group shape="circle" style="margin: auto">
                            <i-button type="success" @click="addRelationTable">&nbsp;&nbsp;添加&nbsp;&nbsp;</i-button>
                            <i-button>&nbsp;删除&nbsp;</i-button>
                            <i-button>序列化</i-button>
                            <i-button>反序列化</i-button>
                        </button-group>
                        <ul id="dataRelationZTreeUL" class="ztree"></ul>
                    </div>
                    <div style="float: right;width: 680px;height: 330px;border: #ddddf1 1px solid;border-radius: 4px;padding: 10px 10px 10px 10px;">

                    </div>
                </div>
            </div>
        </tab-pane>
        <tab-pane name="Design" label="Design">
            <div class="form-design-wraper">
                <div class="left-wraper">
                    <textarea name="html_design" id="html_design">
                    </textarea>
                </div>
                <div class="right-wraper">
                    <tabs>
                        <tab-pane label="Config">
                            <div>Config</div>
                        </tab-pane>
                        <tab-pane label="Element">
                            <div>Element</div>
                        </tab-pane>
                    </tabs>
                </div>
            </div>
        </tab-pane>
        <tab-pane name="HTML" label="HTML">
            <div class="html-design-wraper">
                <div class="left-wraper">
                    <textarea id="TextAreaHTMLEditor" style="height: 99%"></textarea>
                </div>
                <div class="right-wraper">
                    <tabs>
                        <tab-pane label="CodeFragment">
                            <div>Config</div>
                        </tab-pane>
                        <tab-pane label="Element">
                            <div>Element</div>
                        </tab-pane>
                    </tabs>
                </div>
            </div>
        </tab-pane>
        <tab-pane name="JS" label="JS">
            <div class="js-design-wraper">
                <div class="left-wraper">
                    <textarea id="TextAreaJsEidtor"></textarea>
                </div>
                <div class="right-wraper">
                    <tabs>
                        <tab-pane label="CodeFragment">
                            <div>Config</div>
                        </tab-pane>
                        <tab-pane label="Element">
                            <div>Element</div>
                        </tab-pane>
                    </tabs>
                </div>
            </div>
        </tab-pane>
        <tab-pane name="Be Referred" label="Be Referred"></tab-pane>
    </tabs>
</div>
<div id="divSelectTable" title="请选择表" style="display: none">
    <ul id="selectTableZTreeUL" class="ztree"></ul>
</div>
<script>
    var IsTopFramePage=true;
    var appForm = new Vue({
        el:"#appForm",
        data: {
            acInterface:{
                getTablesDataUrl:"/PlatForm/Builder/DataStorage/DataBase/Table/GetTablesForZTreeNodeList",
                getPluginsConfig:"/PlatForm/Builder/WebFormDesign/GetPluginsConfig"
            },
            currUserEntity:null,
            ruleValidate: {
                formName: [
                    {required: true, message: '【名称】不能空！', trigger: 'blur'}
                ],
                formMainTableName: [
                    {required: true, message: '【绑定主表名称】不能空！', trigger: 'blur'}
                ],
                formMainTableCaption:[
                    {required: true, message: '【绑定主表标题】不能空！', trigger: 'blur'}
                ]
            },
            /*Js Bean*/
            formResourceEntity:{
                formId:"",
                formName:"",
                formSingleName:"",
                formCreateTime:DateUtility.GetCurrentData(),
                formCreater:"",
                formUpdateTime:DateUtility.GetCurrentData(),
                formUpdater:"",
                formType:"",
                formIssystem:"否",
                formOrderNum:"",
                formDesc:"",
                formModuleId:"",
                formStatus:"启用",
                formOrganId:"",
                formOrganName:"",
                formMainTableName:"",
                formMainTableCaption:"",
                formDataRelation:"",
                formIsTemplate:"",
                formContentUrl:"",
                formIsResolve:"",
                formHtmlSource:"",
                formHtmlResolve:"",
                formJsContent:"",
                formCssContent:"",
                formConfigContent:""
            },
            relationTableTree:{
                treeObj:null,
                tableTreeSetting:{
                    view: {
                        dblClickExpand: false,//双击节点时，是否自动展开父节点的标识
                        showLine: true,//是否显示节点之间的连线
                        fontCss: {'color': 'black', 'font-weight': 'normal'}
                    },
                    data: {
                        key: {
                            name: "text"
                        },
                        simpleData: {//简单数据模式
                            enable: true,
                            idKey: "id",
                            pIdKey: "parentId",
                            rootPId: "-1"// 1
                        }
                    },
                    callback: {
                        //点击树节点事件
                        onClick: function (event, treeId, treeNode) {
                            if(treeNode.nodeTypeName=="Table") {
                                appForm.tableTree.tableTreeObj.checkNode(treeNode, true, true);
                                appForm.formResourceEntity.formMainTableCaption=treeNode.attr1;
                                appForm.formResourceEntity.formMainTableName=treeNode.value;
                            }
                            else{
                                alert("选中分组");
                            }
                        }
                    }
                },
                tableTreeData:{id:"-1",text:"数据关联",parentId:"",nodeTypeName:"根节点"}
            },
            selectTableTree:{
                tableTreeObj:null,
                tableTreeSetting:{
                    view: {
                        dblClickExpand: false,//双击节点时，是否自动展开父节点的标识
                        showLine: true,//是否显示节点之间的连线
                        fontCss: {'color': 'black', 'font-weight': 'normal'}
                    },
                    check: {
                        enable: true,
                        nocheckInherit: false,
                        chkStyle: "radio",
                        radioType: "all"
                    },
                    data: {
                        key: {
                            name: "text"
                        },
                        simpleData: {//简单数据模式
                            enable: true,
                            idKey: "id",
                            pIdKey: "parentId",
                            rootPId: "-1"// 1
                        }
                    },
                    callback: {
                        //点击树节点事件
                        onClick: function (event, treeId, treeNode) {
                            if(treeNode.nodeTypeName=="Table") {
                                appForm.tableTree.tableTreeObj.checkNode(treeNode, true, true);
                                appForm.formResourceEntity.formMainTableCaption=treeNode.attr1;
                                appForm.formResourceEntity.formMainTableName=treeNode.value;
                            }
                            else{
                                alert("选中分组");
                            }
                        }
                    }
                },
                tableTreeData:null,//${tableTreeData},
                selectedTableName:"无"
            },
            status: BaseUtility.GetUrlParaValue("op")
        },
        mounted:function () {
            this.initPageUI();
            this.bindSelectTableTree();
            this.bindStatusData();
        },
        methods: {
            initPageUI:function(){
                $(".form-design-wraper").height(PageStyleUtility.GetWindowHeight()-60);

                AjaxUtility.Post(this.acInterface.getPluginsConfig,{},function (result) {
                    console.log(result.data);

                    JBuild4D.FormDesign.InitializeCKEditor('html_design',result.data,function () {

                    });
                    JBuild4D.FormDesign.InitializeHTMLCodeDesign();
                },"json");

                //初始化根节点
                this.relationTableTree.treeObj=$.fn.zTree.init($("#dataRelationZTreeUL"), this.relationTableTree.tableTreeSetting,this.relationTableTree.tableTreeData);
                this.relationTableTree.treeObj.expandAll(true);
            },
            addRelationTable:function(){
                $("#divSelectTable").dialog({
                    modal:true,
                    height:600,
                    width:500
                });
            },
            bindSelectTableTree:function () {
                var _self=this;
                AjaxUtility.Post(this.acInterface.getTablesDataUrl,{},function (result) {
                    if(result.success) {
                        _self.selectTableTree.tableTreeData=result.data;
                        //console.log(_self.tree.tableTreeData);
                        _self.selectTableTree.tableTreeObj=$.fn.zTree.init($("#selectTableZTreeUL"), _self.selectTableTree.tableTreeSetting,_self.selectTableTree.tableTreeData);
                        _self.selectTableTree.tableTreeObj.expandAll(true);
                        //fuzzySearch("tableZTreeUL","#txtSearchTableTree",null,true);
                    }
                    else {
                        DialogUtility.Alert(window, DialogUtility.DialogAlertId, {}, result.message, null);
                    }
                },"json");
            },
            bindStatusData:function () {
                this.currUserEntity=CacheDataUtility.GetCurrentUserInfo();
                if(this.status=="add"){
                    this.formResourceEntity.formCreater=this.currUserEntity.userName;
                    this.formResourceEntity.formUpdater=this.currUserEntity.userName;
                }
                else {
                    //this.editTableObj.LoadJsonData(this.tableFieldsData);
                    this.formResourceEntity.formId=BaseUtility.GetUrlParaValue("recordId");
                    this.formResourceEntity.formUpdater=this.currUserEntity.userName;
                    //this.loadData(this.datasetEntity.dsId,this.status);
                }
            },
            tabChange:function (name) {
                if(name=="HTML"){
                    var html=JBuild4D.FormDesign.GetCKEditorHTML();
                    //JBuild4D.FormDesign.SetHTMLEditorHTML("<div id='aaa'><div><div><div>ssssssssss</div></div></div></div>");
                    JBuild4D.FormDesign.SetHTMLEditorHTML(html);
                }
                else if(name=="Design"){

                }
            }
        }
    });
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>列表设计</title>
    <th:block th:replace="Fragment/GeneralLib::GeneralLib"></th:block>
    <th:block th:replace="Fragment/GeneralLib::ZTreeExtendLib"></th:block>
    <th:block th:replace="Fragment/GeneralLib::FormDesignLib"></th:block>
    <th:block th:replace="Fragment/GeneralLib::CodeMirrorLib"></th:block>
    <th:block th:replace="Fragment/GeneralLib::ThemesLib"></th:block>
    <style>
        .cke_button_label {
            display:inline !important;
        }
    </style>
</head>
<body>
<div id="appForm" v-cloak>
    <div style="position: absolute;right: 10px;top: 6px;z-index: 100">
        <button-group size="small">
            <i-button icon="md-cloud-done" type="primary" @click="saveClose()">保存并关闭</i-button>
            <i-button icon="md-search" type="primary" @click="savePreview()">保存并预览</i-button>
            <i-button icon="md-checkmark" type="primary" @click="validateDesign()">校验列表设置</i-button>
            <i-button icon="md-search" type="primary" @click="savePreview()">历史版本</i-button>
        </button-group>
    </div>
    <tabs @on-click="tabChange" v-model="selectedTabName">
        <tab-pane name="Info" label="Info">
            <div style="width: 1024px;margin: auto">
                <div style="width: 500px;height: 560px;border: #ddddf1 1px solid;border-radius: 4px;padding: 10px 20px 10px 10px;float: left">
                    <divider orientation="left" :dashed="true" style="font-size: 12px">表单信息</divider>
                    <i-form  :model="listResourceEntity" :label-width="110">
                        <form-item label="列表名称：">
                            <i-input v-model="listResourceEntity.listName" placeholder="请输入列表名称"></i-input>
                        </form-item>
                        <form-item label="唯一名称：">
                            <i-input v-model="listResourceEntity.listSingleName" placeholder="可以为空"></i-input>
                        </form-item>
                        <form-item label="备注：" style="margin-bottom: 12px">
                            <i-input v-model="listResourceEntity.listDesc" type="textarea" :autosize="{minRows: 12,maxRows: 12}"></i-input>
                        </form-item>
                    </i-form>
                </div>
                <div style="width: 500px;height: 560px;border: #ddddf1 1px solid;border-radius: 4px;padding: 10px 20px 10px 10px;float: right">
                    <divider orientation="left" :dashed="true" style="font-size: 12px">绑定数据集</divider>
                    <dataset-simple-select-comp></dataset-simple-select-comp>
                </div>
            </div>
        </tab-pane>
        <tab-pane name="Design" label="Design">
            <div class="form-design-wraper">
                <div class="left-wraper" style="right: 10px">
                    <textarea name="html_design" id="html_design">
                    </textarea>
                </div>
            </div>
        </tab-pane>
        <tab-pane name="HTML" label="HTML">
            <div class="html-design-wraper">
                <div class="left-wraper code_wraper">
                    <div class="inner">
                        <textarea id="TextAreaHTMLEditor" style="height: 99%"></textarea>
                    </div>
                </div>
                <div class="right-wraper">
                    <tabs>
                        <tab-pane label="CodeFragment">
                            <div>Config</div>
                        </tab-pane>
                        <tab-pane label="Element">
                            <div>Element</div>
                        </tab-pane>
                    </tabs>
                </div>
            </div>
        </tab-pane>
        <tab-pane name="JS" label="JS">
            <div class="js-design-wraper">
                <div class="left-wraper code_wraper">
                    <div class="inner">
                        <textarea id="TextAreaJsEditor"></textarea>
                    </div>
                </div>
                <div class="right-wraper">
                    <tabs>
                        <tab-pane label="CodeFragment">
                            <js-design-code-fragment ref="jsDesignCodeFragment"></js-design-code-fragment>
                        </tab-pane>
                        <tab-pane label="Element">
                            <design-html-elem-list ref="designHtmlElemList"></design-html-elem-list>
                        </tab-pane>
                    </tabs>
                </div>
            </div>
        </tab-pane>
        <tab-pane name="Be Referred" label="Be Referred"></tab-pane>
        <tab-pane name="Config" label="Config"></tab-pane>
    </tabs>
</div>

<script>
    var IsTopFramePage=true;
    var appForm = new Vue({
        el:"#appForm",
        data: {
            acInterface:{
                getTablesDataUrl:"/PlatForm/Builder/DataStorage/DataBase/Table/GetTablesForZTreeNodeList",
                getPluginsConfig:"/PlatForm/Builder/WebFormDesign/GetPluginsConfig",
                saveDataUrl:"/PlatForm/Builder/Form/SaveEdit",
                getDataUrl:"/PlatForm/Builder/Form/GetDetailData"
            },
            currUserEntity:null,
            recordId:BaseUtility.GetUrlParaValue("recordId"),
            /*Js Bean*/
            listResourceEntity:{
                listId:"",
                listCode:"",
                listName:"",
                listSingleName:"",
                listCreateTime:DateUtility.GetCurrentData(),
                listCreater:"",
                listUpdateTime:DateUtility.GetCurrentData(),
                listUpdater:"",
                listType:"",
                listIssystem:"否",
                listOrderNum:"",
                listDesc:"",
                listModuleId:"",
                listStatus:"启用",
                listOrganId:"",
                listOrganName:"",
                listDatasetId:"",
                listHtmlSource:"",
                listHtmlResolve:"",
                listJsContent:"",
                listConfigContent:""
            },
            status: BaseUtility.GetUrlParaValue("op"),
            oldSelectedTabName:"",
            selectedTabName:""
        },
        mounted:function () {
            this.initPageUI();
            this.bindStatusData();
        },
        methods: {
            initPageUI:function(){
                $(".form-design-wraper").height(PageStyleUtility.GetWindowHeight()-60);
                var _self=this;
                AjaxUtility.Post(this.acInterface.getPluginsConfig,{},function (result) {
                    //console.log(result.data);
                    CKEditorUtility.InitializeCKEditor('html_design',result.data,function () {

                    });
                    HTMLEditorUtility.InitializeHTMLCodeDesign();
                    JsEditorUtility.InitializeJsCodeDesign(_self.status);
                    _self.$refs.jsDesignCodeFragment.setJSEditorInstance(JsEditorUtility.GetJsEditorInst());
                    //debugger;
                    _self.getServerDataBind();
                },"json");
            },
            getServerDataBind:function(){
                //获取数据并赋值
                var _self=this;
                DetailPageUtility.BindFormData(this.acInterface.getDataUrl, this.formResourceEntity, this.recordId, this.status,null,function (result) {
                    //alert(_self.formResourceEntity.formDataRelation);
                    //debugger;
                    if(_self.status!="add") {
                        _self.$refs.dbTableRelationComp.setValue(_self.formResourceEntity.formDataRelation);
                        HTMLEditorUtility.SetHTMLEditorHTML(_self.formResourceEntity.formHtmlSource);
                        CKEditorUtility.SetCKEditorHTML(_self.formResourceEntity.formHtmlSource);
                        JsEditorUtility.SetJsEditorJs(_self.formResourceEntity.formJsContent);
                    }
                });
            },
            bindStatusData:function () {
                this.currUserEntity=CacheDataUtility.GetCurrentUserInfo();
                if(this.status=="add"){
                    this.listResourceEntity.listCreater=this.currUserEntity.userName;
                    this.listResourceEntity.listUpdater=this.currUserEntity.userName;
                    this.listResourceEntity.listType="WebList";
                    this.listResourceEntity.listModuleId=BaseUtility.GetUrlParaValue("moduleId");
                    this.oldSelectedTabName="Info";
                }
                else {
                    this.listResourceEntity.listId=BaseUtility.GetUrlParaValue("recordId");
                    this.listResourceEntity.listUpdater=this.currUserEntity.userName;
                    this.oldSelectedTabName="Design";
                    this.selectedTabName="Design";
                    //JBuild4D.FormDesign.SetCKEditorHTML("");
                }
            },
            isHTMLToDesign:function(name){
                if(this.oldSelectedTabName=="HTML"){
                    if(name=="Design"){
                        return true;
                    }
                }
                return false;
            },
            isDesignToHTML:function(name){
                if(this.oldSelectedTabName=="Design"){
                    if(name=="HTML"){
                        return true;
                    }
                }
                return false;
            },
            tabChange:function (name) {
                if(this.isDesignToHTML(name)){
                    var html=CKEditorUtility.GetCKEditorHTML();
                    //JBuild4D.FormDesign.SetHTMLEditorHTML("<div id='aaa'><div><div><div>ssssssssss</div></div></div></div>");
                    HTMLEditorUtility.SetHTMLEditorHTML(html);
                }
                else if(this.isHTMLToDesign(name)){
                    var html=HTMLEditorUtility.GetHtmlEditorHTML();
                    //alert(html);
                    CKEditorUtility.SetCKEditorHTML(html);
                }
                this.oldSelectedTabName=name;
            },
            save:function (successFunc) {
                //debugger;
                var relationConfig=this.$refs.dbTableRelationComp.getValue();
                this.formResourceEntity.formDataRelation=JsonUtility.JsonToString(relationConfig.relationData);
                this.formResourceEntity.formMainTableId=relationConfig.mainTableId;
                this.formResourceEntity.formMainTableName=relationConfig.mainTableName;
                this.formResourceEntity.formMainTableCaption=relationConfig.mainTableCaption;
                this.formResourceEntity.formHtmlSource=CKEditorUtility.GetCKEditorHTML();
                this.formResourceEntity.formJsContent=JsEditorUtility.GetJsEditorJs();

                var validateResult=this.validateSaveEnable(this.formResourceEntity);
                if(validateResult.result){
                    var sendData = JSON.stringify(this.formResourceEntity);
                    //debugger;
                    AjaxUtility.PostRequestBody(this.acInterface.saveDataUrl, sendData, function (result) {
                        //debugger;
                        DialogUtility.Alert(window, DialogUtility.DialogAlertId, {}, result.message, function () {
                            if (result.success) {
                                //window.OpenerWindowObj.appList.reloadData();
                                //DialogUtility.Frame_CloseDialog(window);
                                window.opener._modulelistwebformcomp.reloadData();
                                successFunc();
                            }
                        });
                    }, "json");
                }
                else{
                    DialogUtility.AlertText(validateResult.msg.join("<br />"));
                }
            },
            saveClose:function () {
                this.save(function () {
                    window.close();
                });
            },
            savePreview:function () {
                this.save(function () {

                })
            },
            validateSaveEnable:function(formResourceEntity){
                var resultMsg={
                    result:true,
                    msg:[]
                }

                if(formResourceEntity.formName==""){
                    resultMsg.result=false;
                    resultMsg.msg.push("请填写表单名称!");
                }
                //校验是否设置了主表
                if(formResourceEntity.formMainTableId==""){
                    resultMsg.result=false;
                    resultMsg.msg.push("请设置主表!");
                }
                return resultMsg;
            },
            validateDesign:function (formResourceEntity) {
                if(this.validateSaveEnable(formResourceEntity)){

                }
            }
        }
    });
</script>
</body>
</html>
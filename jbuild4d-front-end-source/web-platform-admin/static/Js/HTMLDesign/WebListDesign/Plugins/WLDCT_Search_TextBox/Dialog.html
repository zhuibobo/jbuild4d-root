<!DOCTYPE html>
<html lang="zh" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <th:block th:replace="Fragment/GeneralLib::GeneralLib"></th:block>
    <th:block th:replace="Fragment/GeneralLib::JBuild4DFormDesignLib"></th:block>
    <th:block th:replace="Fragment/GeneralLib::ThemesLib"></th:block>
</head>
<body>
    <div class="html-design-plugin-dialog-wraper" id="dialogApp" v-cloak>
        <tabs size="small">
            <tab-pane label="绑定信息">
                <list-search-control-bind-to :bind-to-field-prop="bindToField" :default-value-prop="defaultValue" @on-set-completed="setBindCompleted">
                </list-search-control-bind-to>
            </tab-pane>
            <tab-pane label="基础信息">
                <fd-control-base-info v-model="baseInfo">
                </fd-control-base-info>
            </tab-pane>
        </tabs>
    </div>
    <script>
        var DialogApp=new Vue({
            el:"#dialogApp",
            data: {
                baseInfo:CKEditorPluginUtility.DefaultProps.baseInfo,
                defaultValue: CKEditorPluginUtility.DefaultProps.defaultValue,
                dataSetId:null
            },
            mounted:function () {

            },
            methods: {
                ready:function(actionName,sel,parents){
                    this.baseInfo.id="txt_"+StringUtility.Timestamp();
                    this.baseInfo.name=this.baseInfo.id;

                    //从html中查找datasetId;
                    if(sel){
                        for(var i=parents.length-1;i--;i>=0){
                            if(parents[i].getAttribute("datasetid")!=null&&parents[i].getAttribute("datasetid")!=""){
                                console.log(parents[i].getAttribute("datasetid"));
                                this.dataSetId=parents[i].getAttribute("datasetid");
                            }
                        }
                    }
                    //如果查找不到,则使用基础属性中的dataSetId
                    if(!this.dataSetId){
                        console.log(window.parent.listDesign.listResourceEntity.listDatasetId);
                        this.dataSetId=window.parent.listDesign.listResourceEntity.listDatasetId;
                    }
                    if(!this.dataSetId){
                        DialogUtility.AlertText("请先设定DataSet");
                    }
                    else{
                        this.bindDataSetFieldTree(this.dataSetId);
                    }
                },
                bindDataSetFieldTree:function(dataSetId){
                    var dataSetVo=window.parent.listDesign.getDataSet(dataSetId);
                    console.log(dataSetVo);
                },
                setBindCompleted:function(bindToField,defaultValue,validateRules){
                    this.bindToField=bindToField;
                    this.defaultValue=defaultValue;
                    this.validateRules=validateRules;
                },
                getControlProps:function () {
                    var result = {
                        success: true,
                        baseInfo: this.baseInfo,
                        bindToField: this.bindToField,
                        defaultValue: this.defaultValue,
                        validateRules: this.validateRules
                    }
                    return CKEditorPluginUtility.ValidateSerializeControlDialogCompletedEnable(result);
                },
                setControlProps:function ($elem,props) {
                    console.log($elem.parent());
                    this.baseInfo = props.baseInfo ? props.baseInfo : this.baseInfo;
                    this.bindToField = props.bindToField ? props.bindToField : this.bindToField;
                    this.defaultValue = props.defaultValue ? props.defaultValue : this.defaultValue;
                    this.validateRules = props.validateRules ? props.validateRules : this.validateRules;
                }
            }
        });
    </script>
</body>
</html>